name: Setup BeenCoin Project

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main ]

jobs:
  setup-project:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create project structure
      run: |
        # í´ë” êµ¬ì¡° ìƒì„±
        mkdir -p app/{core,api/v1/endpoints,models,services,utils} tests
        mkdir -p .github/workflows
        
        # requirements.txt ìƒì„±
        cat > requirements.txt << 'EOF'
        fastapi==0.104.1
        uvicorn==0.24.0
        sqlalchemy==2.0.23
        sqlmodel==0.0.11
        pydantic==2.5.0
        python-jose==3.3.0
        passlib==1.7.4
        python-multipart==0.0.6
        httpx==0.25.2
        websockets==12.0
        redis==5.0.1
        aioredis==2.0.1
        pytest==7.4.3
        pytest-asyncio==0.21.1
        aiohttp==3.9.1
        celery==5.3.4
        python-binance==1.0.19
        EOF
        
        # app/core/config.py ìƒì„±
        mkdir -p app/core
        cat > app/core/config.py << 'EOF'
        from pydantic_settings import BaseSettings
        from typing import Optional

        class Settings(BaseSettings):
            API_V1_STR: str = "/api/v1"
            PROJECT_NAME: str = "BeenCoin API"
            DATABASE_URL: str = "sqlite+aiosqlite:///./beencoin.db"
            SECRET_KEY: str = "your-secret-key-change-in-production"
            ALGORITHM: str = "HS256"
            ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
            BINANCE_API_URL: str = "https://api.binance.com/api/v3"
            REDIS_URL: str = "redis://localhost:6379"
            INITIAL_BALANCE: float = 1000000

            class Config:
                case_sensitive = True

        settings = Settings()
        EOF
        
        # app/models/database.py ìƒì„±
        mkdir -p app/models
        cat > app/models/database.py << 'EOF'
        from sqlmodel import SQLModel, Field, Relationship
        from typing import Optional, List
        from datetime import datetime
        from decimal import Decimal

        class User(SQLModel, table=True):
            id: Optional[int] = Field(default=None, primary_key=True)
            email: str = Field(unique=True, index=True)
            hashed_password: str
            created_at: datetime = Field(default_factory=datetime.utcnow)
            accounts: List["TradingAccount"] = Relationship(back_populates="user")
            orders: List["Order"] = Relationship(back_populates="user")

        class TradingAccount(SQLModel, table=True):
            id: Optional[int] = Field(default=None, primary_key=True)
            user_id: int = Field(foreign_key="user.id")
            balance: Decimal = Field(default=1000000, max_digits=20, decimal_places=8)
            total_profit: Decimal = Field(default=0, max_digits=20, decimal_places=8)
            user: User = Relationship(back_populates="accounts")
            positions: List["Position"] = Relationship(back_populates="account")

        class Order(SQLModel, table=True):
            id: Optional[int] = Field(default=None, primary_key=True)
            user_id: int = Field(foreign_key="user.id")
            symbol: str
            order_type: str
            order_status: str = "pending"
            price: Decimal = Field(max_digits=20, decimal_places=8)
            quantity: Decimal = Field(max_digits=20, decimal_places=8)
            filled_quantity: Decimal = Field(default=0, max_digits=20, decimal_places=8)
            created_at: datetime = Field(default_factory=datetime.utcnow)
            updated_at: datetime = Field(default_factory=datetime.utcnow)
            user: User = Relationship(back_populates="orders")

        class Position(SQLModel, table=True):
            id: Optional[int] = Field(default=None, primary_key=True)
            account_id: int = Field(foreign_key="tradingaccount.id")
            symbol: str
            quantity: Decimal = Field(max_digits=20, decimal_places=8)
            average_price: Decimal = Field(max_digits=20, decimal_places=8)
            current_value: Decimal = Field(max_digits=20, decimal_places=8)
            account: TradingAccount = Relationship(back_populates="positions")

        def create_db_and_tables(engine):
            SQLModel.metadata.create_all(engine)
        EOF
        
        # app/main.py ìƒì„±
        mkdir -p app
        cat > app/main.py << 'EOF'
        from fastapi import FastAPI
        from fastapi.middleware.cors import CORSMiddleware
        from app.core.config import settings

        app = FastAPI(
            title=settings.PROJECT_NAME,
            openapi_url=f"{settings.API_V1_STR}/openapi.json"
        )

        app.add_middleware(
            CORSMiddleware,
            allow_origins=["*"],
            allow_credentials=True,
            allow_methods=["*"],
            allow_headers=["*"],
        )

        @app.get("/")
        async def root():
            return {"message": "BeenCoin API ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ìž…ë‹ˆë‹¤!"}

        @app.get("/health")
        async def health_check():
            return {"status": "healthy"}

        if __name__ == "__main__":
            import uvicorn
            uvicorn.run(app, host="0.0.0.0", port=8000)
        EOF
        
        # __init__.py íŒŒì¼ë“¤ ìƒì„±
        touch app/__init__.py
        touch app/core/__init__.py
        touch app/api/__init__.py
        touch app/api/v1/__init__.py
        touch app/api/v1/endpoints/__init__.py
        touch app/models/__init__.py
        touch app/services/__init__.py
        touch app/utils/__init__.py
        
        # README.md ìƒì„±
        cat > README.md << 'EOF'
        # BeenCoin - ì‹¤ì‹œê°„ ì•”í˜¸í™”í ëª¨ì˜íˆ¬ìž í”Œëž«í¼

        ## ðŸš€ ì£¼ìš” ê¸°ëŠ¥
        - ì‹¤ì‹œê°„ ì•”í˜¸í™”í ì‹œì„¸ ì¡°íšŒ (Binance API)
        - ëª¨ì˜íˆ¬ìž ì£¼ë¬¸ ì‹œìŠ¤í…œ
        - WebSocket ì‹¤ì‹œê°„ ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë°
        - í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬

        ## âš¡ ë¹ ë¥¸ ì‹œìž‘
        ```bash
        pip install -r requirements.txt
        uvicorn app.main:app --reload
        ```

        ## ðŸ“Š API ë¬¸ì„œ
        - Swagger UI: http://localhost:8000/docs
        - ReDoc: http://localhost:8000/redoc

        ## ðŸ—ï¸ í”„ë¡œì íŠ¸ êµ¬ì¡°
        ```
        BeenCoin/
        â”œâ”€â”€ app/
        â”‚   â”œâ”€â”€ main.py
        â”‚   â”œâ”€â”€ core/          # ì„¤ì • ê´€ë¦¬
        â”‚   â”œâ”€â”€ models/        # ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸
        â”‚   â”œâ”€â”€ api/v1/        # API ì—”ë“œí¬ì¸íŠ¸
        â”‚   â”œâ”€â”€ services/      # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        â”‚   â””â”€â”€ utils/         # ìœ í‹¸ë¦¬í‹°
        â”œâ”€â”€ tests/
        â””â”€â”€ requirements.txt
        ```
        EOF
        
        # .gitignore ìƒì„±
        cat > .gitignore << 'EOF'
        __pycache__/
        *.pyc
        *.pyo
        *.pyd
        .Python
        env/
        venv/
        .venv/
        *.sqlite3
        *.db
        .DS_Store
        .coverage
        htmlcov/
        .pytest_cache/
        *.log
        instance/
        .webassets-cache
        .scrapy
        docs/_build/
        target/
        .ipynb_checkpoints
        .python-version
        .env
        .venv
        npm-debug.log*
        yarn-debug.log*
        yarn-error.log*
        EOF

    - name: Commit and push project files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "ðŸš€ BeenCoin í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì • ì™„ë£Œ" || echo "No changes to commit"
        git push
