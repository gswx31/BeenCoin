# ============================================================================
# íŒŒì¼ ìœ„ì¹˜: .github/workflows/backend-ci-cd.yml
# ============================================================================
# ì„¤ëª…: Pytest ê¸°ë°˜ CI/CD íŒŒì´í”„ë¼ì¸ (Binance API Mock í¬í•¨)
# ============================================================================

name: Backend CI/CD (Pytest)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.10'
  # âœ… CI í™˜ê²½ ëª…ì‹œ (conftest.pyì—ì„œ ìë™ ê°ì§€í•˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œë„ ì„¤ì •)
  CI: true
  MOCK_BINANCE: true

jobs:
  # ============================================
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Black formatting check
      run: black --check app/ tests/
      continue-on-error: true
    
    - name: Ruff linting
      run: ruff check app/ tests/
      continue-on-error: true

  # ============================================
  # 2. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run unit tests
      run: |
        pytest tests/unit/ -v \
          --cov=app \
          --cov-report=xml \
          --cov-report=term-missing \
          --junitxml=junit/unit-results.xml
      env:
        CI: true
        MOCK_BINANCE: true
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: junit/unit-results.xml

  # ============================================
  # 3. API í†µí•© í…ŒìŠ¤íŠ¸ (Binance API Mock ì ìš©)
  # ============================================
  api-integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Initialize database
      run: |
        python -c "from app.core.database import create_db_and_tables; create_db_and_tables()"
    
    - name: Run API integration tests
      run: |
        pytest tests/integration/test_all_api_endpoints.py -v \
          --cov=app \
          --cov-report=xml \
          --cov-report=term-missing \
          --junitxml=junit/integration-results.xml \
          --maxfail=10
      env:
        CI: true
        MOCK_BINANCE: true
        DATABASE_URL: 'sqlite:///./test.db'
        SECRET_KEY: 'test-secret-key-for-ci'
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: junit/integration-results.xml
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage.xml

  # ============================================
  # 4. E2E ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: api-integration-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Initialize database
      run: |
        python -c "from app.core.database import create_db_and_tables; create_db_and_tables()"
    
    - name: Run E2E tests
      run: |
        pytest tests/integration/test_all_api_endpoints.py::TestE2EScenarios -v \
          --maxfail=5
      env:
        CI: true
        MOCK_BINANCE: true
      continue-on-error: true

  # ============================================
  # 5. Docker ë¹Œë“œ & í…ŒìŠ¤íŠ¸
  # ============================================
  docker-test:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    needs: api-integration-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t beencoin-backend:test .
        echo "âœ… Docker build successful!"
    
    - name: Run Docker container
      run: |
        docker run -d -p 8000:8000 --name test-backend \
          -e CI=true \
          -e MOCK_BINANCE=true \
          beencoin-backend:test
        sleep 10
        
        # Health check
        docker logs test-backend
        curl -f http://localhost:8000/health || exit 1
        echo "âœ… Docker container is healthy!"
    
    - name: Cleanup
      if: always()
      run: |
        docker stop test-backend || true
        docker rm test-backend || true

  # ============================================
  # 6. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
  # ============================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, api-integration-tests, e2e-tests, docker-test]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "================================"
        echo "ğŸ§ª TEST RESULTS SUMMARY"
        echo "================================"
        echo ""
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Unit Tests: ${{ needs.unit-tests.result }}"
        echo "API Tests: ${{ needs.api-integration-tests.result }}"
        echo "E2E Tests: ${{ needs.e2e-tests.result }}"
        echo "Docker: ${{ needs.docker-test.result }}"
        echo ""
        echo "ğŸ“ Note: Binance API is mocked in CI environment"
        echo ""
        
        # í•µì‹¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì²´í¬ (E2EëŠ” optional)
        if [ "${{ needs.unit-tests.result }}" != "success" ] || \
           [ "${{ needs.api-integration-tests.result }}" != "success" ] || \
           [ "${{ needs.docker-test.result }}" != "success" ]; then
          echo "âŒ CRITICAL TESTS FAILED"
          exit 1
        else
          echo "âœ… ALL CRITICAL TESTS PASSED!"
        fi