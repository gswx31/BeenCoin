# ============================================================================
# íŒŒì¼ ìœ„ì¹˜: .github/workflows/backend-cicd.yml
# ============================================================================
# ì„¤ëª…: Pytestë§Œ ì‚¬ìš©í•˜ëŠ” ê°„ì†Œí™”ëœ CI/CD íŒŒì´í”„ë¼ì¸
# ìƒì„± ë°©ë²•:
#   1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ: mkdir -p .github/workflows
#   2. ì´ ë‚´ìš©ì„ .github/workflows/backend-cicd.yml ì— ì €ì¥
# ============================================================================

name: Backend CI/CD (Pytest)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ============================================
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Black formatting check
      run: black --check app/ tests/
      continue-on-error: true
    
    - name: Ruff linting
      run: ruff check app/ tests/
      continue-on-error: true

  # ============================================
  # 2. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run unit tests
      run: |
        pytest tests/unit/ -v \
          --cov=app \
          --cov-report=xml \
          --cov-report=term-missing

  # ============================================
  # 3. API í†µí•© í…ŒìŠ¤íŠ¸
  # ============================================
  api-integration-tests:
    name: API Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Initialize database
      run: |
        python -c "from app.core.database import create_db_and_tables; create_db_and_tables()"
    
    - name: Start backend server
      run: |
        nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
        echo $! > server.pid
        
        # ì„œë²„ ì‹œì‘ ëŒ€ê¸° (ìµœëŒ€ 30ì´ˆ)
        for i in {1..30}; do
          if curl -f http://localhost:8000/health 2>/dev/null; then
            echo "âœ… Server started successfully!"
            break
          fi
          echo "Waiting for server... ($i/30)"
          sleep 1
        done
        
        # ì„œë²„ ë¡œê·¸ í™•ì¸
        cat server.log
    
    - name: Run API integration tests
      run: |
        pytest tests/integration/test_all_api_endpoints.py -v \
          --cov=app \
          --cov-report=xml \
          --cov-report=term-missing \
          --maxfail=5
      env:
        API_URL: http://localhost:8000
    
    - name: View server logs
      if: always()
      run: cat server.log || echo "No server logs"
    
    - name: Stop server
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
        fi

  # ============================================
  # 4. E2E ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: api-integration-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Initialize database
      run: |
        python -c "from app.core.database import create_db_and_tables; create_db_and_tables()"
    
    - name: Start backend server
      run: |
        nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
        sleep 5
    
    - name: Run E2E tests
      run: |
        pytest tests/integration/test_all_api_endpoints.py::TestAllAPIEndpoints::test_complete_trading_flow -v
    
    - name: Stop server
      if: always()
      run: pkill -f uvicorn || true

  # ============================================
  # 5. Docker ë¹Œë“œ & í…ŒìŠ¤íŠ¸
  # ============================================
  docker-test:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    needs: api-integration-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t beencoin-backend:test .
        echo "âœ… Docker build successful!"
    
    - name: Run Docker container
      run: |
        docker run -d -p 8000:8000 --name test-backend beencoin-backend:test
        sleep 10
        
        # Health check
        docker logs test-backend
        curl -f http://localhost:8000/health || exit 1
        echo "âœ… Docker container is healthy!"
    
    - name: Cleanup
      if: always()
      run: |
        docker stop test-backend || true
        docker rm test-backend || true

  # ============================================
  # 6. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
  # ============================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, api-integration-tests, e2e-tests, docker-test]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "================================"
        echo "ğŸ§ª TEST RESULTS SUMMARY"
        echo "================================"
        echo ""
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Unit Tests: ${{ needs.unit-tests.result }}"
        echo "API Tests: ${{ needs.api-integration-tests.result }}"
        echo "E2E Tests: ${{ needs.e2e-tests.result }}"
        echo "Docker: ${{ needs.docker-test.result }}"
        echo ""
        
        # ì‹¤íŒ¨ ì²´í¬
        if [ "${{ needs.code-quality.result }}" != "success" ] || \
           [ "${{ needs.unit-tests.result }}" != "success" ] || \
           [ "${{ needs.api-integration-tests.result }}" != "success" ] || \
           [ "${{ needs.e2e-tests.result }}" != "success" ] || \
           [ "${{ needs.docker-test.result }}" != "success" ]; then
          echo "âŒ SOME TESTS FAILED"
          exit 1
        else
          echo "âœ… ALL TESTS PASSED!"
        fi